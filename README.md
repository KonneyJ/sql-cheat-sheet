# Шпаргалка по SQL
## Общая информация
Базы данных бывают разными, и различаются они способом хранения информации.

Если данные представлены в виде связанных таблиц, такую базу данных называют **реляционной**. Элементы таблицы РБД имеют специальные названия. 

Столбцы называются **полями**, колонками или признаками, строки - **записями**, объекты на пересечении полей и записей - **ячейками**.

Каждая строка таблицы содержит уникальную информацию. Для этого к каждой записи добавляется специальный признак - **первичный ключ**. Такой ключ не позволит создать абсолютно одинаковые записи. Еще первичный ключ позволяет установить связи между таблицами. Это позволяет делать запросы, которые объединяют записи из нескольких таблиц базы.

## СУБД
Для управления базами данных существует специальное программное обеспечение. Такое ПО называют **система управления базами данных** (database management system, DBMS) или **СУБД**. 

Возможности СУБД:
- создать базу или таблицу в базе
- внести новые данные или удалить устаревшие
- выгрузить нужную информацию, задав условие
- обеспечить безопасный доступ к данным  

Виды СУБД: 
- PostgreSQL
- MySQL
- MongoDB
- Oracle
- Redis и др

## SQL
Реляционными базами данных управляют с помощью языка **SQL** или **Structured Query Language** (язык структурированных запросов). 

SQL - декларативный язык, то есть описывает не алгоритм действий, а данные которые хотят получить. Как выполнить такую команду решает СУБД.  

У SQL также много **диалектов** - наборов дополнительных команд, которые расширяют стандартные возможности языка.

## Структура запросов
Запросы на языке SQL пишут с помощью операторов.   

**SELECT** - оператор, с помощью которого описывают, что нужно выгружать из базы  
**FROM** - оператор, с помощью которого описывают, откуда именно нужно выгружать данные    
**AS** - оператор после которого пишут псевдоним поля  
**LIMIT** - оператор, который ставят в конце запроса и после него указывают количество записей(строк), которые нужно выгрузить  
**OFFSET** - оператор, который указывает с какой записи начать выборку  
**WHERE** - оператор, после которого указывают условие для выгрузки данных     
**GROUP BY** - оператор, который группирует данные по категориям  
**DATE_TRUNC('отрезок времени', поле)** - оператор, с помощью которого можно выделить начало элемента даты (первый день нужного месяца)    
**EXTRACT(отрезок времени FROM поле)** - оператор, с помощью которого можно выделить номер элемента даты (года, месяца, недели)  
**COUNT()** - оператор подсчитывает число записей  
**SUM()** - оператор подсчитывает сумму записей  
**AVG()** - оператор находит среднее арифмитическое записей  
**MIN()** - оператор находит минимальное значение записей  
**MAX()** - оператор находит максимальное значение записей  
**DISTINCT()** - оператор выдает только уникальные значения  
**HAVING** - оператор фильтрует значений полученные в результате группировки


Чтобы оставлять пометки в коде, в SQL можно использовать комментарии
```sql
-- Так выглядит однострочный комментарий

/* Так
выглядит
многострочный
комментарий*/
```

## Оператор WHERE
Оператор **WHERE** указывают после оператора **FROM** 
```sql
SELECT поле_1, -- поля для выгрузки
       поле_2 
             ...
FROM таблица -- таблица, из которой выгружают данные
WHERE поле > 4; -- условие для среза данных
``` 
Задать условия можно с помощью операторов сравнения. Они выглядят так: 
- '=' - равно
- '!=' - не равно
- '>' - больше
- '<' - меньше
- '>=' - больше или равно
- '<=' - меньше или равно

Если значение сравнивают с символьным типом, набор символов нужно взять в одинарные кавычки:  
 **WHERE поле = 'Иванов'**   
 
 Также это правило касается времени и даты:  
 **WHERE поле = '2013-07-01'**

Поле, по которому формируется условие, необязательно должно присутствовать в **SELECT**

В PostgreSQL в операторе **WHERE** нельзя использовать псевдонимы. Потому что "под капотом" во время компиляции **WHERE** выполняется раньше, чем **SELECT**, когда псевдонимы еще не назначены.

Также оператор **WHERE** работает только с исходными данными, с результатами вычислений он работать не умеет.

### Логические операторы
В SQL три логических оператора: **AND**, **OR**, **NOT** - и помощник **IN**

**AND** применяют в том случае, если выгружаемые данные должны соответствовать всем перечисленным условиям  

**OR** позволяет отобрать данные, которые удовлетворяют одному из условий  

**NOT** - с его помощью выгружают данные, которые не соответствуют условию  

**IN** работает также, как несколько операторов OR. Достаточно прописать его после нужного поля и в скобках перечислить необходимые значения
```sql
WHERE age > 25 
  AND first_name IN ('Виктор', 'Любовь', 'Борис', 'Станислав', 'Алина', 'Евгения', 'Ольга');
```

### Правила действия логических операторов
Условия, которые объединяются в запросе после **WHERE**, представляют собой утверждения. Каждое утверждение проходит проверку на истинность. 

Если утверждение истинно, получаем значение **TRUE**, либо **FALSE** - если утверждение ложно.

Каждый из логических операторов действует по своим правилам:

- **AND** - возвращает **TRUE**, только если оба логических значения тоже **TRUE**
- **OR** - возвращает **TRUE**, если хотя бы одно из логических значений тоже **TRUE**
- **NOT** - меняет значение на противоположное: **TRUE** на **FALSE**, а **FALSE** на **TRUE**

Условия с разными логическими операторами имеют разный приоритет. Первым всегда выполняется условие с оператором **NOT**, за ним - **AND** и в последнюю очередь - условие с **OR**.

Управлять порядком можно еще с помощью скобок - арифметические операции в скобках выполняются первыми.

## Агрегирующие функции
**Агрегирующие функции** позволяют проводить расчеты над группами данных и отображать результат в виде одной строки.

Основные агрегирующие функции в SQL:
- SUM(поле) - возвращает сумму значений в поле
- AVG(поле) - находит среднее арифмитическое для значений в поле
- MIN(поле) - возвращает минимальное значение в поле
- MAX(поле) - возвращает максимальное значение в поле
- COUNT(поле) - выводит количество записей в поле

Агрегирующие функции можно комбинировать с условиями и вычислениями.

## DISTINCT
Функция **DISTINCT** позволяет находить и рассчитывать показатели только по уникальным значениям. 

**DISTINCT** можно использовать как с агрегирующими функциями, так и без них.
```sql
SELECT DISTINCT(percent_of_discount)
FROM buyer;
```

## Как группировать данные по категориям
**Группировка** - это расчет агрегирующей фукнции не по всем данным, а по отдельным категориям.

Для группировки применяют оператор **GROUP BY**: его записывают после оператора FROM, если условия нет, и после WHERE - если оно есть.
```sql
SELECT gender,
       AVG(age)
FROM buyer
GROUP BY gender;
```
Группировка оператором **GROUP BY** устроена так: сначала группируют данные по одной категории, для нее вычисляют среднее, результат выводится на экран. И так по каждой категории.

Группировку можно комбинировать с агрегирующими фукнциями и фильтрацией: можно указывать несколько агрегирующих функций.

Для оператора **GROUP BY** можно и не указывать агрегирующую фукнцию, тогда на экране отобразится только список уникальных значений, которые содержатся в поле.

### Особенности запросов с GROUP BY
1. В SELECT не обязательно указывать поле, по которому производится группировка. Оно просто не отобразится при выводе
2. Но если поле указано в SELECT, то оно обязательно должно быть указано и в группировке
3. В группировках можно указывать псевдонимы

## Как отфильтровать данные после группировки. Оператор HAVING
Оператор **HAVING** фильтрует значения, полученные в результате группировки. То есть работает не с новыми полями, а результатом вычислений. Его записывают после **GROUP BY**.

### Особенности оператор HAVING
1. Условие, по которому оператор HAVING фильтрует данные необязательно указывать в SELECT
2. Оператор HAVING работает только если в запросе есть группировка GROUP BY. Без нее оператор работать не будет.


## Как работать с датой и временем 
### Функция DATE_TRUNC
Дата и время часто хранятся в таком виде: '2009-11-19 11:03:05'

Функция **DATE_TRUNC** "усекает" дату и время до необходимого значения

Синтаксис функции такой: **DATE_TRUNC('отрезок времени', поле)**

Отрезок времени может быть разным, главное - не забывать одинарные кавычки
- 'microseconds' - микросекунды
- 'milliseconds' - миллисекунды
- 'second' - секунды
- 'minute' - минута
- 'hour' - час
- 'day' - день
- 'week' - неделя
- 'month' - месяц
- 'quarter' - квартал
- 'year' - год 
- 'decade' - десятилетие
- 'century' - век

```sql
SELECT *
FROM hotdog
WHERE DATE_TRUNC('month', date) = '2022-02-01'
LIMIT 5;
```

При использовании оператора DATE_TRUNC PostgreSQL возвращает данные, которые имеют тип **timestamp with time zone**. 

Этот тип данных похож на **date**, только вдобавок содержит время. Кроме того, такой тип производит поправку на часовой пояс, в котором находится компьютер пользователя.

### Функция EXTRACT
Функцию **EXTRACT** используют, чтобы получить конкретную часть даты - год, месяц или минуту. 

Ее синтаксис - **EXTRACT(отрезок времени FROM поле)**

Одинарные кавычки для значений внутри скобок не нужны. Отрезок времени можно представить следующими значениями:
- CENTURY - век
- YEAR - год
- QUARTER - квартал
- MONTH - месяц
- WEEK - неделя в году 
- DAY - день 
- DOY (day of the year) - день года, выраженный числом от 1 до 365
- DOW (day of the week) - день недели, выраженный числом от 0 до 6, где понедельник - 1, а воскресенье - 0
- ISODOW (day of the week и ISO 8601) - день недели, выраженный числом от 1 до 7, где понедельник — 1, воскресенье — 7
- HOUR - час 
- MINUTE - минута
- SECOND - секунда
- MILLISECOND - миллисекунда

```sql
SELECT date,
       EXTRACT(WEEK FROM date)
FROM hotdog
LIMIT 5;
```

## Стиль запросов
**SQL** - язык, не чувствительный к регистру: между операторами SELECT и select нет разницы. Но в SQL есть правила стиля.

### Правило № 1. Выделение ключевых слов
**Первое правило хорошего стиля** - отделять ключевые слова от названий столбцов и таблиц. Ключевые слова пишут в верхнем регистре, а названия - в нижнем.
```sql
SELECT *
FROM pizza;
```
Так запрос писать не стоит.
```sql
Select *
From pizza;
```

### Правило № 2. Перенос строк
**Второе правило хорошего стиля** - перечислять поля и функции, перенося их на новую строку и выстраивая в один столбик. Так проще понять, какие поля или значения будут выгружены.
```sql
SELECT last_name,
       first_name,
       title
FROM staff;
```
Оформить запрос по всем правилам можно вручную или с помощью SQL-форматера, например [SQLFormat](https://sqlformat.org/).